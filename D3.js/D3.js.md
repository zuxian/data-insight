

###  å¯¼è¯­

D3.jsï¼ˆData-Driven Documentsï¼‰é€šè¿‡D3æä¾›çš„æ¥å£æ¥åŸºäºæ•°æ®æ“æ§æ–‡æ¡£çš„å„ä¸ªå›¾å…ƒã€‚

- å¯è§†åŒ–åŸºæœ¬å›¾è¡¨ï¼šæŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ã€æ•£ç‚¹å›¾ã€åŠ›å¯¼å›¾ç­‰ã€‚å¯å®šåˆ¶åŒ–å°ç»†èŠ‚ã€‚
- æ•°æ®ï¼šè¯»å–CSVã€ JSONã€å±‚çº§æ•°æ®ã€ç½‘ç»œæ•°æ®ç­‰ã€‚
- åŠ¨ç”»ã€ äº¤äº’ã€‚
- D3.jsä¸­çš„å¸¸ç”¨æ¥å£

>  SVG â€“ å¯ç¼©æ”¾çŸ¢é‡å›¾å½¢ï¼ˆ Scalable Vector Graphicsï¼‰

SVGæ˜¯D3.jsä¸»è¦æ“ä½œçš„å¯¹è±¡â€˜ç”»å¸ƒâ€™ï¼ŒD3.jsè·å–svgå¯¹è±¡ï¼š `const svg = d3.select(â€˜svgâ€™);` 

SVGåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºåŒ…å«ç”»åœ¨ä¸Šé¢çš„å„ä¸ªå›¾å…ƒã€‚

SVGä½œä¸ºçŸ¢é‡å›¾ï¼Œä¸ä¼šéšç€å›¾ç‰‡çš„ç¼©æ”¾è€Œå‘ç”Ÿå¤±çœŸï¼›

![](images/svg.png)

### è¯­æ³•åŸºç¡€

D3æŸ¥è¯¢SVGï¼šd3.select(â€˜#rect1â€™)ã€d3.selectAll(â€˜.class1â€™)   ã€IDå‰åŠ â€˜#â€™ï¼Œ Classå‰åŠ â€˜.â€™ ï¼Œæ ‡ç­¾åå‰ä¸åŠ ç¬¦å·ã€‘

D3 æ·»åŠ &åˆ é™¤ SVGå…ƒç´ ï¼š  `d3.select(â€˜#mainsvgâ€™).append(â€˜gâ€™).attr(â€˜idâ€™, â€˜maingroupâ€™)`ï¼Œ	element.remove()



> D3è®¾ç½®SVGä¸­çš„å±æ€§ï¼Œå¸¸è§çš„å±æ€§ï¼š

â€¢ id, classï¼ˆå¯ä½¿ç”¨.attrè®¾ç½®ï¼‰
â€¢ x, y, cx, cy ï¼ˆæ³¨æ„å±å¹•çš„åæ ‡ç³»ï¼‰
â€¢ fill, stroke
â€¢ height, width, r (åœ†çš„åŠå¾„)
â€¢ transform -> translate, rotate, scale  

`  <rect id='rect3' class='class1' stroke='black' height='200' width='66' fill='#7289AB' x='300' y='-100'>  `

é“¾å¼è°ƒç”¨ï¼š selection.attr(â€¦).attr(â€¦).attr(â€¦)ï¼Œè¿”å›çš„æ˜¯é€‰æ‹©çš„å›¾å…ƒæœ¬èº«



> æ•°æ®çš„è¯»å–  
>

CSVæ•°æ®ï¼šç¬¬ä¸€è¡Œä¸ºå±æ€§åˆ—è¡¨ï¼Œåç»­æ¯è¡Œå¯¹åº”ä¸€â€˜æ¡â€™æ•°æ®ã€‚CSVæœ¬è´¨ä¸Šæ˜¯çº¯æ–‡æœ¬ï¼ŒåŒºåˆ«äºEXCELçš„æ ¼å¼ã€‚

`d3.csv(â€˜path/to/data.csvâ€™).then( data => { ... } )`



> æ•°å€¼è®¡ç®—

d3.max(array) -- æ•°ç»„ä¸­çš„æœ€å¤§å€¼ã€d3.min(array) -- æ•°ç»„ä¸­çš„æœ€å°å€¼ã€d3.extent(array) -- è¿”å›æœ€å°å€¼ä¸æœ€å¤§å€¼



> æ¯”ä¾‹å°º  
>

å¸¸ç”¨äºæ˜ å°„æ•°æ®ã€åˆ›å»ºåæ ‡è½´

d3.scaleLinear()ï¼šçº¿æ€§æ¯”ä¾‹å°ºï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚

domain().range()ï¼šè®¾ç½®æ¯”ä¾‹å°ºçš„å®šä¹‰åŸŸå’Œå€¼åŸŸï¼Œéƒ½æ˜¯è¿ç»­çš„ï¼Œéœ€åˆ†åˆ«ç»™å‡ºæœ€å¤§å€¼ä¸æœ€å°å€¼ã€‚

â€‹								`d3.scaleLinear().domain([min_d, max_d]).range([min, max])`  

d3.scaleBand()ï¼š æ¡å¸¦æ¯”ä¾‹å°ºï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚

Bandæ¯”ä¾‹å°ºçš„å®šä¹‰åŸŸæ˜¯ç¦»æ•£çš„ï¼Œå€¼åŸŸæ˜¯è¿ç»­çš„ã€‚`d3.scaleBand().domain(array).range([min, max])`  

scale.padding(0.1)ï¼š è®¾ç½®æ¡å¸¦çš„é—´è·å å„è‡ªåŒºåŸŸçš„æ¯”é‡ã€‚

scale.bandwidth():   è¿”å›æ¡å¸¦çš„é•¿åº¦ã€‚



> åæ ‡è½´

ä»»ä½•åæ ‡è½´åœ¨åˆå§‹åŒ–ä¹‹åä¼šé»˜è®¤æ”¾ç½®åœ¨åæ ‡åŸç‚¹ï¼Œéœ€è¦è¿›ä¸€æ­¥çš„å¹³ç§»ã€‚

åæ ‡è½´æœ¬è´¨ä¸Šæ˜¯å›¾å…ƒçš„é›†åˆã€‚
â€¢ `d3.selectAll('.tick text').attr('font-size', '2emâ€™);`
â€¢ .tickæ˜¯D3å¯¹äºåæ ‡è½´å®šä¹‰çš„ç»Ÿä¸€class

åæ ‡è½´çš„æ ‡ç­¾ï¼š 

é€šè¿‡å¯¹åæ ‡è½´çš„`<g>`æ ‡ç­¾ `.append(â€˜textâ€™)`æ¥å®ç°
â€¢ ï¼ˆå·¦ï¼‰çºµè½´åæ ‡éœ€è¦ `.attr(â€˜transformâ€™, â€˜rotate(-90)â€™)` æ¥æ—‹è½¬  

```js
//  å®šä¹‰åæ ‡è½´ï¼ˆè¿”å›ä»æ˜¯å‡½æ•°ï¼‰
const yAxis = d3.axisLeft(yScale);    // å·¦ä¾§åæ ‡è½´
const xAxis = d3.axisBottom(xScale);  // åº•ä¾§åæ ‡è½´

//  ç»˜åˆ¶åæ ‡è½´
const yAxisGroup = g.append('g').call(yAxis);
const xAxisGroup = g.append('g').call(xAxis);

// ç”»å¸ƒä¸»ä½“éœ€è¦Margin
const margin = {top: 60, right: 30, bottom: 60, left: 200}
// è®¡ç®—å®é™…æ“ä½œçš„ inner é•¿/å®½
const innerWidth = width - margin.left - margin.right;
const innerHeight = height - margin.top - margin.bottom;
// åœ¨SVGä¸‹é¢å¤–å®šä¹‰ä¸€ä¸ªç»„ä½œä¸ºæ–°çš„æ ¹èŠ‚ç‚¹
const g = svg.append('g').attr('id', 'maingroup').attr('transform', `translate(${margin.left}, ${margin.top})`);


```

selection.call(â€¦)ï¼šå®šä¹‰ä¸€ä¸ªç©ºç™½çš„`<g>`ï¼Œè¾“å…¥ä¸ºå¦ä¸€ä¸ªå‡½æ•°ï¼Œç”¨è¯¥å‡½æ•°ä¿®æ”¹`<g>`

åæ ‡è½´é€šå¸¸åˆå§‹åŒ–åœ¨æ‰€åœ¨çˆ¶èŠ‚ç‚¹çš„å·¦ä¸Šè§’ï¼Œéœ€è¦åœ¨ç”»å¸ƒmarginä¸€æ®µè·ç¦»ç”»å›¾



> Data-Joinï¼š  ç»‘å®šæ•°æ®ä¸å›¾å…ƒ  
>

`d3.selectAll(â€˜.classâ€™).data(myArray).join(â€˜å›¾å…ƒâ€™).attr(d => â€¦)`

myArrayçš„æ¯æ¡æ•°æ®ä¼šä¸ä¸€ä¸ªå›¾å…ƒç»‘å®šã€‚    .join(â€¦)ä¼šæ ¹æ®æ•°æ®çš„æ¡ç›®è¡¥å…¨oråˆ é™¤å›¾å…ƒã€‚  

```js
mainGroup.selectAll('rect').data(data).join('rect')
.attr('height', yScale.bandwidth())
.attr('width', d => xScale(d.globalsale))
.attr('x', 0).attr('y', d => yScale(d.platform));
```

![](images/datajoin.png)

> é¢œè‰² â€“ â€˜fillâ€™å±æ€§



>   D3æä¾›çš„å„ç§è‰²ç›˜  
>

https://github.com/d3/d3-scale-chromatic

ç¦»æ•£-->ç¦»æ•£çš„æ˜ å°„ï¼š`const color = d3.scaleOrdinal().domain(naiveKeys).range(d3.schemeSet3)`





###  åŠ¨ç”»

> transition

D3çš„selectionsåè°ƒç”¨transitionï¼Œå°†åç»­çš„.attr(â€¦)åŠ ä»¥åŠ¨ç”»æ•ˆæœï¼Œ  æ”¯æŒé“¾å¼è°ƒç”¨  

ç”¨2000æ¯«ç§’æŠŠé€‰æ‹©å›¾å…ƒçš„å®½å˜æˆ400ï¼š

`d3.select("#my_rect").transition().duration(2000).attr("width", "400");` 



>   â€˜easeâ€™   åŠ¨ç”»è¿‡æ¸¡æ–¹å¼ï¼Œä½œç”¨åœ¨transitionå¯¹è±¡å    

`d3.select("#my_rect").transition().duration(2000).ease(d3.easeLinear).attr(â€¦)`

 d3.easeCubic é»˜è®¤ï¼ŒåŠ é€Ÿ->å‡é€Ÿã€d3.easeLinear çº¿æ€§ã€ d3.easeElastic å¼¹å°„



> åŠ¨ç”» â€“ åŒæ­¥  
>

```js
//  æ‰€æœ‰ç»‘å®šçš„å›¾å…ƒä¼šåŒæ­¥æ’­æ”¾åŠ¨ç”»
rects.transition(transition).attr(â€¦).attr(â€¦)
circles.transition(transition).attr(â€¦).attr(â€¦)

// ç­‰å¾…ä¸€ä¸ªtransitionå…¨éƒ¨ç›¸å…³çš„å›¾å…ƒæ‰§è¡Œå®Œæ¯•
await transition.end();

//  æŸ±å½¢å›¾çš„ é•¿æ–¹å—ä¸æ–‡æ¡ˆä¸€èµ·å˜åŠ¨
(async () => {
    while(true){
        data.forEach(d => { d.value = Math.random() * 20; });
        let transition = d3.transition().duration(1000)//.ease(d3.easeElastic);

        rects.transition(transition).attr('width', d => xScale(d.value))
        .attr('fill', () => d3.interpolateRainbow(Math.random()));

        texts.transition(transition).attr('x', d => xScale(d.value))
        .text(d => formatPercent(d.value));

        await transition.end();
    }
})()
```

> æ•°å­—çš„æ ¼å¼åŒ–ï¼š  d3.format(â€˜.2fâ€™)(666.666)  
>

å®ç°åŠ¨æ€æ•£ç‚¹å›¾

```js
const renderupdate = async function(seq){
    const g = d3.select('#maingroup');
    d3.select('#date_text').text(seq[0]['æ—¥æœŸ']);
    let transition = d3.transition().duration(aduration).ease(d3.easeLinear); 

    let circleupdates = g.selectAll('circle').data(seq).join('circle')
    .attr('fill', d => color[keyValue(d)] )
    .attr('opacity', .8)
    .transition(transition)
    .attr('cy', d => yScale(yValue(d)))
    .attr('cx', d => xScale(xValue(d))) 
    .attr('r', c => rValue(c));

    let textupdates = g.selectAll('.province_text').data(seq).join('text')
    .attr("class", "province_text")
    .attr("dy", "1em")
    .style("text-anchor", "middle")
    .attr("fill", "#333333")
    .text( d => keyValue(d))
    .transition(transition)
    .attr('x', d => xScale(xValue(d)))
    .attr('y', d => yScale(yValue(d)));

    await transition.end();
};

for(let i = 0; i < sequential.length; i++){ await renderupdate(sequential[i]); }
```

###  Path

å›¾å…ƒPathï¼š Pathçš„å¸¸è§å±æ€§ã€‚   â€˜dâ€™å±æ€§-â€˜ç¬”ç”»â€™çš„è®¾ç½®è§„åˆ™ã€‚
D3.jsçš„â€˜dâ€™å±æ€§æ¥å£ï¼šd3.line()     d3.arc()
åŸºäºd3.line()ç»˜åˆ¶æŠ˜çº¿å›¾ï¼šâ€¢ æ—¶é—´æ•°æ®çš„å¤„ç†ä¸æ—¶é—´æ¯”ä¾‹å°ºã€‚  â€¢ å•ä¸€å›¾å…ƒçš„Data-Joinï¼Œ selection.datum(â€¦)ã€‚
åŸºäºd3.arc()ç»˜åˆ¶é¥¼å›¾ï¼š     â€¢ ç¦»æ•£æ¯”ä¾‹å°ºä¸D3.jsçš„é…è‰²æ–¹æ¡ˆï¼› â€¢ d3.pie()  

> **`<path>`  å±æ€§**

dï¼š `<path>`å‹¾å‹’çš„æ–¹å¼ï¼Œå³â€˜ç¬”ç”»â€™ã€‚

```js
â€¢ M = moveto(M X,Y) ï¼šå°†ç”»ç¬”ç§»åŠ¨åˆ°æŒ‡å®šçš„åæ ‡ä½ç½®
â€¢ L = lineto(L X,Y) ï¼šç”»ç›´çº¿åˆ°æŒ‡å®šçš„åæ ‡ä½ç½®
â€¢ H = horizontal lineto(H X)ï¼šç”»æ°´å¹³çº¿åˆ°æŒ‡å®šçš„Xåæ ‡ä½ç½®
â€¢ V = vertical lineto(V Y)ï¼šç”»å‚ç›´çº¿åˆ°æŒ‡å®šçš„Yåæ ‡ä½ç½®
â€¢ C = curveto(C X1,Y1,X2,Y2,ENDX,ENDY)ï¼šä¸‰æ¬¡è´èµ›æ›²çº¿
â€¢ S = smooth curveto(S X2,Y2,ENDX,ENDY)ï¼šå¹³æ»‘æ›²ç‡
â€¢ Q = quadratic Belzier curve(Q X,Y,ENDX,ENDY)ï¼šäºŒæ¬¡è´èµ›æ›²çº¿
â€¢ T = smooth quadratic Belzier curveto(T ENDX,ENDY)ï¼šæ˜ å°„
â€¢ A = elliptical Arc(A RX,RY,XROTATION,FLAG1,FLAG2,X,Y)ï¼šå¼§çº¿
â€¢ Z = closepath()ï¼šå…³é—­è·¯å¾„
```

â€¢ fillï¼š å¡«å……é¢œè‰²ã€‚
â€¢ strokeï¼šæè¾¹é¢œè‰²ã€‚
â€¢ stroke-widthï¼šæè¾¹å®½åº¦ã€‚
â€¢ transformï¼šå˜æ¢

```html
<svg width="100px" height="100px">
   <path d="M0 0 H 90 V 90 H 10 L 10 10" />     // ç›´çº¿å‘½ä»¤ --ã€‹ ç»˜åˆ¶æ­£æ–¹å½¢
</svg>

// ä¸‰æ¬¡è´å¡å°”æ›²çº¿C-->èµ·ç‚¹åŸºäºâ€˜Mâ€™å‘½ä»¤, C x1 y1, x2 y2, x yï¼šMèµ·ç‚¹å¼€å§‹çš„æ›²çº¿ã€‚(x,y)ï¼šæ›²çº¿çš„ç»ˆç‚¹.
// æ›²çº¿æ²¿ç€èµ·ç‚¹åˆ°ç¬¬ä¸€æ§åˆ¶ç‚¹çš„æ–¹å‘ä¼¸å‡ºï¼Œé€æ¸å¼¯æ›²ï¼Œç„¶åæ²¿ç€ç¬¬äºŒæ§åˆ¶ç‚¹åˆ°ç»ˆç‚¹çš„æ–¹å‘ç»“æŸã€‚
<path d="M130 110 C 120 140, 180 140, 170 110" stroke="black" fill="transparent"/>

```

![1675304700026](./images/è´å¡å°”.jpg)

> **D3.jsçš„â€˜dâ€™å±æ€§æ¥å£**  

d3.line(â€¦).x(â€¦).y(â€¦)        ç”¨äºå°†å¤šä¸ªç‚¹ä¾æ¬¡è¿çº¿ï¼Œå¦‚æŠ˜çº¿å›¾ã€‚
d3.arc(â€¦).innerRadius(â€¦).outerRadius(â€¦)       å¼§ï¼Œç”¨äºé¥¼å›¾ã€‚
d3.geoPath().projection()        ç”¨äºåœ°ç†ã€åœ°å½¢æ•°æ®ã€‚
d3.area()         åŒºåŸŸçš„â€˜dâ€™å±æ€§ï¼Œå¦‚ä¸»é¢˜æ²³æµã€‚

- **d3.line().x(â€¦).y(â€¦).curve(d3Curve)**  

```js
const data = [{'x': 100, 'y': 100},{'x': 200, 'y': 300},{'x': 300, 'y': 50},{'x': 400, 'y': 600}];
const pathLine = d3.line().x(d => d.x).y(d => d.y).curve(d3.curveBasis); 
svg.append('path').attr('stroke','black').attr('fill','none').attr('d',pathLine(data))
```

- **d3.arc().innerRadius(100).outerRadius(200).padAngle(0.1)** 

  åœ†å¼§çš„å†…åŠå¾„ã€å¤–åŠå¾„ï¼Œåœ†å¼§ä¸¤ä¾§çš„é¢„ç•™é—´éš”padAngleï¼Œå‡½æ•°å…¥å‚ä¸ºä¸€ä¸ªå¯¹è±¡--èµ·å§‹å’Œç»ˆæ­¢è§’åº¦  

```js
const part3 = {'startAngle': 4.34, 'endAngle': 6.283185307179586};
const pathArc3 = d3.arc().innerRadius(0).outerRadius(160).padAngle(0.1);
svg.append('path').attr('stroke', 'black').attr('fill', 'steelblue').attr('transform', 'translate(800, 400)').attr('d', pathArc3(part3));
```

>   **d3.line()ç»˜åˆ¶æŠ˜çº¿å›¾**

- **æ—¶é—´æ•°æ®å¤„ç†ï¼šæ—¶é—´æ¯”ä¾‹å°º  d3.scaleTime()**   

d3.scaleTime().domain(d3.extent(data.map(d => d.day))).range([0, 1600]);
â€¢ è®¾ç½®æ—¶é—´æ¯”ä¾‹å°ºçš„å®šä¹‰åŸŸä¸å€¼åŸŸã€‚
â€¢ JStçš„Dateå¯¹è±¡æ”¯æŒâ€˜é¡ºåºâ€™ã€ â€™>â€™ä¸â€™<â€™ï¼Œå› æ­¤å¯æŒ‰ç…§æ•°å€¼å‹å˜é‡åŸºäºd3.extentæ¥å£è®¡ç®—ä¸¤ä¸ªç«¯ç‚¹å€¼ã€‚

```js
data.forEach(d => { d.day = new Date(d.day); d.sale = +(d.sale); })
xScale.domain(d3.extent(data.map(d => d.day))).range([0, innerWidth]).nice();
const timeFormat = d3.timeFormat('%b-%d')   // è¿”å›ä¸€ä¸ªå‡½æ•°ï¼šè¾“å…¥æ—¥æœŸ  --ã€‹ â€˜æœˆ-æ—¥â€™æ ¼å¼ã€‚
const xAxis = d3.axisBottom(xScale).ticks(15).tickFormat(timeFormat);
```

- **selection.datum()     å¯¹å•ä¸€å›¾å…ƒç»‘å®šå•ä¸€æ•°æ®**

.data(â€¦)     å°†ä¸€æ‰¹å›¾å…ƒä¸ä¸€æ‰¹æ•°æ®ç»‘å®š
.datum(â€¦)  ç»™ç‰¹å®šçš„ä¸€ä¸ªå›¾å…ƒç»‘å®šä¸€ä¸ªæ•°æ®ï¼Œç›´æ¥æŠŠä¸€ä¸ªæ•°ç»„ä½œä¸ºå•ä¸€å›¾å…ƒç»‘å®šç»™ä¸€ä¸ª`<path>`å³å¯ã€‚  

```js
const line = d3.line().x(d=>xScale(d.day)).y(d=>yScale(d.sale)).curve(d3.curveLinear);
mainGroup.append('path').datum(data).attr('fill','none').attr('d', line).attr('stroke','black')
```

> **d3.arc()ç»˜åˆ¶é¥¼å›¾**  

- d3.pie()ï¼šç”±â€˜æ•°å€¼â€™åˆ°â€˜æ¯”ä¾‹â€™çš„è½¬åŒ–ã€‚æŠŠæ¯”ä¾‹æ˜ å°„åˆ°[0, 2Pi]çš„å¼§åº¦åŒºé—´

![1675318482225](images/1675318482225.png)

- **scaleOrdinal   ç¦»æ•£æ¯”ä¾‹å°º**ä¸D3.jsçš„é…è‰²æ–¹æ¡ˆ  `d3.scaleOrdinal().domain(â€¦).range(â€¦)`

D3.jsçš„é…è‰²æ–¹æ¡ˆd3.schemeSet1ã€ d3.schemeSet2ã€ d3.schemeSet3ã€‚æ˜¯æ•°ç»„ã€‚ä¸å¤Ÿå¯äº’ç›¸æ‹¼æ¥

```js
const pie = d3.pie().value(d => d.population);
const arcData = pie(data);

const color = d3.scaleOrdinal().domain(data.map(d => d.city))
						  .range(d3.schemeSet2.concat(d3.schemeSet3));

const path = d3.arc().innerRadius(60).outerRadius(260);

svg.selectAll('path').data(arcData).join('path').attr('d', path)
.attr('transform', `translate(${width / 2}, ${height / 2})`)     // åœ†ä¸­å¿ƒ
.attr('fill', d => color(d.data.city));

const arcOuter = d3.arc().innerRadius(280).outerRadius(280);
svg.append('g').attr('transform', `translate(${width / 2}, ${height / 2})`)
.selectAll('text').data(arcData).join('text')
.attr('transform', d => `translate(${arcOuter.centroid(d)})`)    // æ¯ä¸ªåœ†å¼§çš„ä¸­å¿ƒ
.attr('text-anchor', 'middle').text(d => d.data.city);
```

- **ä¸ºé¥¼å›¾æ·»åŠ æ–‡å­—æ ‡ç­¾**

`const arcOuter = d3.arc().innerRadius(280).outerRadius(280);`    å®šä¹‰ä¸€ä¸ªå®Œå…¨â€˜è´´â€™åœ¨å¤–å›´çš„arcå‡½æ•°ã€‚`arcOuter.centroid({â€˜startAngleâ€™: 0, â€˜endAngleâ€™: 1.186})`     è¿”å›è¾“å…¥åœ†å¼§çš„ä¸­å¿ƒç‚¹åæ ‡ã€‚



###  åœ°å›¾ä¸åœ°ç†

- JSONä¸geoJSONï¼šâ€¢ jsonçš„æ•°æ®æ ¼å¼ä¸è¯»å–ã€‚â€¢ geoJsonçš„æ•°æ®æ ¼å¼ã€‚

- d3-geoï¼š
  â€¢ åœ°å›¾æ•°æ®(ç»çº¬åº¦)åˆ°ç”»å¸ƒçš„æ˜ å°„(æŠ•å½±)ï¼š d3.geoPath().projection(â€¦)ã€‚
  â€¢ â€˜dâ€™å±æ€§æ¥å£ï¼š d3.geoPath()ã€‚

- åŸºäºd3-geoç»˜åˆ¶åŒ—äº¬å¸‚åœ°å›¾ã€‚

- d3-contourï¼š ç­‰å€¼çº¿æ•°æ®çš„è¾“å…¥ä¸å¤„ç†ã€‚

-  åŸºäºd3-contourä¸d3-geoç»˜åˆ¶ç­‰å€¼çº¿å›¾ï¼š
  â€¢ d3.scaleSequentialï¼šåŸºäºæ’å€¼çš„è¿ç»­æ¯”ä¾‹å°ºã€‚
  
  

>  geoJson
>

ä¸€ä¸ªgeoJsonåŒ…æ‹¬å¦‚ä¸‹å†…å®¹ï¼š
â€¢ â€˜typeâ€™ï¼šâ€˜FeatureCollectionâ€™
â€¢ â€˜featuresâ€™ï¼Œä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«è‹¥å¹²ä¸ªå½¢çŠ¶çš„å‡ ä½•ä¸å½¢çŠ¶çš„å±æ€§ï¼š
	â€¢ typeï¼šâ€˜Featureâ€™,
	â€¢ geometryï¼š å‡ ä½•ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚
	â€¢ propertiesï¼š å±æ€§ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚åŒ…å«é‚®æ”¿ç¼–ç ã€åœ°åŒºåç§°ã€äººå£ã€æ°”å€™ã€æ –æ¯ç‰©ç§ç­‰ã€‚



å°†geoJsonä¸­çš„å‡ ä½•æ•°æ®(geometries)ç»çº¬åº¦ï¼Œæ˜ å°„åˆ°ç”»å¸ƒä¸Šï¼Œéœ€è¦æŠ•å½±ã€‚

- d3.geoNaturalEarth1()ï¼š  è¿”å›çš„æŠ•å½±å‡½æ•°ï¼Œè¾“å…¥ä¸º geoJsonå«ç»çº¬åº¦çš„ç‚¹ï¼Œ  è¾“å‡ºï¼šç”»å¸ƒå«æ¨ªçºµåæ ‡ç‚¹

- æŠ•å½±å‡½æ•°çš„å®šä¹‰åŸŸå’Œå€¼åŸŸï¼š  `proj.fitSize([width, height], geoJson)`  



> d3.geoPath()  
>

d3.geoPath()ï¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥geoJsonçš„ä¸€ä¸ªâ€˜Featureâ€™ï¼Œè¾“å‡º`<path>`çš„â€˜dâ€™å±æ€§

`d3.geoPath()(geoJson.features[0]) // M713.617444890755,527.4596`  

d3.geoPath().projection(â€¦)ï¼Œ  ç”Ÿæˆçš„â€˜dâ€™å±æ€§ï¼Œè®¾ç½®æŠ•å½±ã€‚  



> åŸºäºd3-geoç»˜åˆ¶åœ°å›¾

```js
const projection = d3.geoNaturalEarth1();     // é€‰æ‹©æŠ•å½±æ–¹å¼
projection.fitSize([width, height], data);    // è®¾ç½®ç”»å¸ƒå¤§å°
const path = d3.geoPath().projection(projection); // è¿”å›å‡½æ•°ï¼Œè¾“å‡º<path>çš„â€˜dâ€™å±æ€§
console.log(path(data.features[0]))    // æ‰“å°ç¬¬ä¸€ä¸ªåœ°åŒºå›¾å…ƒæŠ•å½±ä¹‹åçš„æ•°æ®

svg.selectAll('path').data(data.features).join('path')
 										 .attr('stroke', 'black').attr('fill', 'none')
										 .attr('d', path).attr('id', d => d.properties.name);
```

- åœ°å›¾æ·»åŠ æ ‡ç­¾  ----  æ•°æ®ä¸­å¿ƒcentroidï¼š 

```js
.attr('transform', d => `translate(${projection([d.properties.centroid[0], d.properties.centroid[1]])})`)
```



> d3-contourï¼š ç­‰å€¼çº¿æ•°æ®çš„è¾“å…¥ä¸å¤„ç†

D3.jsçš„â€˜contourâ€™æ¨¡å—ä½œç”¨ï¼šåœ¨è¾“å…¥â€˜çŸ©é˜µâ€™çš„å…ƒç´ (å·¦)ä¹‹é—´å½¢æˆè½®å»“(ä¸­)ï¼Œå°†å€¼(value)
ç›¸è¿‘çš„å…ƒç´ åŒ…å›´åœ¨ä¸€èµ·ï¼Œæœ€ç»ˆ(æ‹Ÿåˆ)å¾—åˆ°æ¯ä¸ªè½®å»“çš„å‡ ä½•(å³)ã€‚

![](images/contour.png)

è½®å»“çº¿è¾“å…¥çš„JSONæ•°æ®æ ¼å¼ï¼š
â€¢ çŸ©é˜µçš„å®½ widthã€  â€¢ çŸ©é˜µçš„é«˜ heightã€  â€¢ çŸ©é˜µçš„å€¼ï¼šæ•°å€¼çš„æ•°ç»„ï¼ˆä¸€é˜¶ï¼‰ã€‚
â€¢ è¡Œä¸»åºï¼šå³(ğ‘–, ğ‘—)è¡¨ç¤ºæ•°ç»„ä¸­çš„ç¬¬(ğ‘– + ğ‘— Ã— ğ‘¤ğ‘–ğ‘‘ğ‘¡â„)ä¸ªå…ƒç´ ã€‚

- d3.contours()ï¼š è¿”å›ç­‰å€¼çº¿ç”Ÿæˆå‡½æ•°ï¼Œå°†çŸ©é˜µè½¬æ¢ä¸ºå‡ ä½•ï¼Œè¾“å…¥æ•°ç»„ï¼Œè¾“å‡ºgeoJsonçš„geometryå¯¹è±¡

- d3.contours().size([width, height])ï¼š   è®¾ç½®çŸ©é˜µçš„è¡Œæ•°ä¸åˆ—æ•° ([n, m])  
- d3.contours().thresholds( array )ï¼š     è®¾ç½®è½®å»“çš„é˜ˆå€¼ã€‚é˜ˆå€¼æ•°é‡==è½®å»“æ•°é‡ï¼Œå³æ¯ä¸ªé˜ˆå€¼å¯¹åº”ä¸€ä¸ªè½®å»“ã€‚
  â€¢ å€¼(value)  >=  æŸä¸€ä¸ªé˜ˆå€¼ï¼Œä¼šè¢«åŒ…å«åœ¨è¿™ä¸ªé˜ˆå€¼çš„è½®å»“ã€‚
  â€¢ ç›¸é‚»å´å±äºä¸åŒé˜ˆå€¼(è½®å»“)çš„å…ƒç´ é—´ï¼Œä½¿ç”¨marching squaresåˆ†ç•Œ

- d3.contours().smooth(true/false)ï¼š   æ˜¯å¦å¹³æ»‘è½®å»“ï¼Ÿ   è½®å»“æœ¬è´¨ä¸Šæ˜¯â€˜æ°´å¹³ã€ç«–ç›´ã€æ–œâ€™ä¸‰ç§ç§»åŠ¨æ–¹å¼  

```js
const contours=d3.contours().size([width,height]).thresholds(thresholds).smooth(true);
const geoPolygons = contours(data.values);
```



>  d3-contour â€“ è½®å»“geoJsonçš„æŠ•å½±

d3.contour()å¯¼å‡ºçš„è½®å»“æ•°æ®(geoJson)è°ƒæ•´ä¸ºç”»å¸ƒçš„å°ºå¯¸ï¼šéœ€(d3-geo-projection)æŠ•å½±åšâ€˜æ¯”ä¾‹å°ºâ€™æ˜ å°„å¹¶æŠŠgeoJsonè¡¥å…¨ï¼Œéœ€d3.geoPathå°†geoJsonè½¬æ¢ä¸º`<path>`çš„â€˜dâ€™å±æ€§ã€‚

- æ’å€¼çš„è¿ç»­æ¯”ä¾‹å°º  `d3.scaleSequential( interpolator ).domain([min, max]) ` 

  æ¯”å¦‚é¢œè‰²åˆ†é…ï¼š `d3.scaleSequential(d3.interpolatePlasma).domain(d3.extent(data.values)); `



>  d3-contourä¸d3-geoç»˜åˆ¶ç­‰å€¼çº¿å›¾

```js
// æ„é€ ç­‰å€¼çº¿ç”Ÿæˆå‡½æ•°;
const contours=d3.contours().size([width,height]).thresholds(thresh).smooth(true);
const geoPolygons = contours(data.values);

// æ„é€ GeoJsonå¹¶FitSizeã€‚
const geoJson = { "type": "FeatureCollection", "features": [] };
for (const geoPolygon of geoPolygons) {     // è¡¥å…¨æ•°æ®ï¼Œæˆä¸ºå®Œæ•´çš„geoJson
    geoJson.features.push({ 'geometry': geoPolygon });
}
const projection = d3.geoNaturalEarth1();   // æŠ•å½±å‡½æ•°
projection.fitSize([width, height], geoJson);  // æ¯”ä¾‹å°º
const path = d3.geoPath();
path.projection(projection);   // å°†geoJsonè½¬æ¢ä¸º`<path>`çš„â€˜dâ€™å±æ€§

// Data-Join; 
svg.selectAll('.myPath').data(geoPolygons).join('path')
.attr('class', 'myPath').attr("fill", d => color(d.value))
.attr("stroke", "white").attr("stroke-width", 1).attr('opacity', 0.3)
.attr('d', d => path(d));
```



###  äº¤äº’

`selection.on(â€˜eventNameâ€™, (event, d) => {è§¦å‘åŠ¨ä½œ}) ` 

```js
// ç‚¹å‡»ï¼Œéšæœºæ”¹å˜é¢œè‰²
d3.select("#my_rect").on('click', (event, d) => {
	 d3.select(event.currentTarget).attr('fill', d3.interpolateRainbow(Math.random()));
});
```

- clickï¼šé¼ æ ‡å·¦é”®å•å‡»ã€‚
-  mouseoverï¼šé¼ æ ‡ç§»â€˜å…¥â€™æŸä¸ªå›¾å…ƒã€‚
-  mouseoutï¼šé¼ æ ‡ç§»â€˜å‡ºâ€™æŸä¸ªå›¾å…ƒã€‚
- keydownï¼šæŸä¸€ä¸ªé”®ç›˜çš„â€˜é”®â€™è¢«æŒ‰ä¸‹ã€‚
-  contextmenuï¼šé¼ æ ‡å³é”®å•å‡»ã€‚éœ€é˜»æ­¢æµè§ˆå™¨çš„é»˜è®¤è¡Œä¸º event.preventDefault();
-  mousemoveï¼šé¼ æ ‡ç§»åŠ¨ã€‚

>  D3-Tipæ‚¬æµ®æ¡†

D3-Tipç”¨äºå¿«é€Ÿç”Ÿæˆã€æ·»åŠ æˆ–éšè—æ ‡ç­¾ï¼Œä¸æ˜¯D3.jsè‡ªå¸¦çš„æ¥å£ï¼Œå¯¼å…¥éœ€è¦é¢å¤–çš„JSè„šæœ¬ã€‚

- åˆå§‹åŒ–ä¸€ä¸ªTipï¼š`const tip = d3.tip().html((event, d) => d.properties.name)`

  å‘ŠçŸ¥Tipè¦å¦‚ä½•æ ¹æ®è¾“å…¥çš„æ•°æ®æ˜¾ç¤ºæ ‡ç­¾ï¼Œ (event, d) => d.properties.name

- svg.call(tip)ï¼šç±»ä¼¼åæ ‡è½´çš„æ·»åŠ ï¼Œæ­£å¼æ¸²æŸ“å‡ºTipã€‚
- tip.show(event, d)ï¼šåŸºäºäº‹ä»¶ä¸å›¾å…ƒç»‘å®šçš„æ•°æ®ï¼Œæ˜¾ç¤ºTipã€‚
- tip.hide(event, d)ï¼šåŸºäºäº‹ä»¶ä¸å›¾å…ƒç»‘å®šçš„æ•°æ®ï¼Œéšè—Tipã€‚

```js
const tip = d3.tip().html((event, d) => d.properties.name);
svg.call(tip);
tip.attr('class', 'd3-tip');

mainGroup.selectAll('path').data(data.features).join('path')
    .attr('stroke', 'black').attr('fill', 'white')
    .attr('d', path)
    .attr('id', d => d.properties.name)
    .on('mouseover', tip.show)
    .on('mouseout', tip.hide);
```

> é”®ç›˜äº‹ä»¶ 

d3.select(â€˜bodyâ€™).on(â€˜keydownâ€™, f);      é€šè¿‡event.keyCodeè·å¾—é”®å€¼ã€‚

```js
let isTransitioning = false;
const step = 60;
const duration = 1000;
const keyTranslate = (at, s) => {
    isTransitioning = true;
    let transition = d3.transition().duration(duration).on('end', () => isTransitioning = false); 
    d3.select('#keyele').transition(transition).attr(at, function(){
        return +d3.select(this).attr(at) + s;
    });
}  // é€šè¿‡ W/A/S/D   æ§åˆ¶å›¾å…ƒ ä¸Šä¸‹å·¦å³ ç§»åŠ¨
d3.select('body').on('keydown', async function(event){
    if(isTransitioning){ return;  }
    if(event.keyCode === 87){ keyTranslate('cy', -step); }      // W
    else if(event.keyCode === 83){ keyTranslate('cy', step); }		// S
		else if(event.keyCode === 65){ keyTranslate('cx', -step); }		// A
    else if(event.keyCode === 68){  keyTranslate('cx', step); }		// D  
});
```

###  æ•°æ®å †å 

> D3.jsçš„â€˜stackâ€™æ•°æ®å †å ï¼š æ•°æ®å †å åçš„æ ¼å¼ã€‚ å †å çš„å–å€¼ä¸é¡ºåºã€‚
> â€˜stackâ€™å®ç°å †å æŸ±çŠ¶å›¾ï¼šåµŒå¥—æ•°ç»„çš„æœ€å¤§å€¼è®¡ç®—ã€‚   Data-JoinåµŒå¥—ã€ç»§æ‰¿ä¸ä¼ é€’ã€‚
> stackâ€™å®ç°ä¸»é¢˜æ²³æµï¼š  åŒºåŸŸçš„â€˜dâ€™å±æ€§æ¥å£ï¼š d3.area()ã€‚



å®šä¹‰æ•°æ®å †å å‡½æ•°ã€‚ `let stack = d3.stack()ï¼›  let stackedData = stack(data)`
è¿”å›ç»“æœä»¥å±æ€§ä¸ºå•ä½ï¼Œå°†æ•°æ®åˆ†å †ã€‚æ¯å †å«è‹¥å¹²å¯¹åº”å±æ€§å †å åçš„ä½ç½®--èµ·ç‚¹å’Œç»ˆç‚¹



æ•°æ®åŸæœ¬çš„å½¢å¼ï¼šå››æ¡æ•°æ®ã€æ¯æ¡æœ‰å››ä¸ªè¦å †å çš„å±æ€§ã€‚

![1675777536216](C:/Users/fzuxi/AppData/Roaming/Typora/typora-user-images/1675777536216.png)



![](images/stack-data.png)



- å †å çš„å–å€¼ï¼š stack.keys([â€œapplesâ€, â€œbananasâ€]);    // åªå †å è‹¹æœå’Œé¦™è•‰

- å †å çš„é¡ºåºï¼š`stack.orders(d3.stackOrderNone); `     // éšKeyçš„é¡ºåºã€‚
  						`stack.orders(d3.stackOrderAscending);`     // æŒ‰ç…§å †å å€¼å‡åº

- å–åµŒå¥—æ•°ç»„çš„æœ€å¤§å€¼ï¼š  `d3.max([[1,2,3], [666,233,999], [110,120,119]], a => d3.max(a))`

```js
const yScale = d3.scaleLinear()
.domain([0, d3.max(naiveStack, d => d3.max(d, subd => subd[1]))])
.range([innerHeight, 0]).nice();
```

- Data-JoinåµŒå¥—ã€ä¼ é€’ä¸ç»§æ‰¿ï¼š

selection.data(data)ï¼š æ•°æ®æ•°ç»„ä¼šè¢«åˆ†ç»™å„ä¸ªç»‘å®šçš„å›¾å…ƒï¼Œ

`selection.data(data).attr(â€¦).selectAll(â€¦).data( d => d ).join(â€¦)`ï¼šæŠŠçˆ¶èŠ‚ç‚¹çš„æ•°æ®è¿›ä¸€æ­¥æŒ‰æ•°ç»„æ‹†åˆ†ï¼Œåˆ†ç»™å„ä¸ªåç»­çš„å­èŠ‚ç‚¹ã€‚

å›¾å…ƒç»‘å®šçš„æ•°æ®ä¼šè¢«â€˜.append(â€¦)â€™æ·»åŠ çš„å­èŠ‚ç‚¹ç»§æ‰¿ï¼š
`let gs = svg.selectAll(â€˜gâ€™).data(data).join(â€˜gâ€™);`     åŸºäºData-Joinæ·»åŠ è‹¥å¹²`<g>`ã€‚
`gs.append(â€˜rectâ€™);`     ä¸ºæ¯ä¸ª`<g>`æ·»åŠ çŸ©å½¢ï¼Œæ¯ä¸ªçŸ©å½¢ç»‘å®šçš„æ•°æ®éš`<g>`ã€‚



- åŸºäºâ€˜stackâ€™å®ç°å †å æŸ±çŠ¶å›¾

```js
var naiveStack = d3.stack().keys(naiveKeys).order(d3.stackOrderNone)(naiveData);

g.selectAll('.datagroup').data(naiveStack).join('g')
.attr('class', 'datagroup')
.attr('fill', d => color(d.key))
.selectAll('.datarect').data(d => d).join('rect')
.attr('class', 'datarect')
.attr('y', d => yScale(d[1]))
.attr('x', d => xScale(xValue(d.data)))
.attr('height', d => yScale(d[0]) - yScale(d[1]))
.attr('width', xScale.bandwidth());
```



> d3.area(â€¦)

- let path = d3.area()      â€˜areaâ€™ç”Ÿæˆå‡½æ•°ï¼Œè¾“å…¥ä¸ºæ•°ç»„ï¼Œè¾“å‡ºä¸º`<path>`çš„â€˜dâ€™å±æ€§å€¼ã€‚
  â€¢ path.x(d => xScale(d.data.ym)) 	// è®¾ç½®xè½´çš„å–å€¼éšç»‘å®šæ•°æ®çš„.data.ymå±æ€§ã€‚
  â€¢ path.y1(d => yScale(d[1])) 	// è®¾ç½®ä¸Šç•Œyè½´ã€‚
  â€¢ path.y0(d => yScale(d[0]))	 //è®¾ç½®ä¸‹ç•Œyè½´ã€‚

- path.curve(â€¦)ï¼š
  â€¢ è®¾ç½®â€˜areaâ€™ä¸Šè¾¹ç•Œä¸ä¸‹è¾¹ç•Œçš„æ‹Ÿåˆæ–¹å¼ï¼ŒåŒd3.line().curve()ã€‚
  â€¢ e.g., path.curve(d3.curveCardinal.tension(0.5));  

```js
// define an area generator;
let area = d3.area().x(d => xScale(d.data.ym))
  .y1(d => yScale(d[1])).y0(d => yScale(d[0])).curve(d3.curveCardinal.tension(0.5));

// data-join;
g.selectAll('.riverPath').data(stackedData, d => d.key).join('path')
.attr('class', 'riverPath').attr('d', area).attr('fill', d => color(d.key));
```

ç›´æ–¹å›¾ d3.histogram: ç”¨äºå°†æ•°æ®æŒ‰ç…§æŸä¸€å±æ€§åˆ†å¸ƒåœ¨ä¸åŒçš„åŒºåŸŸ
é¥¼å›¾ d3.pie: ç”¨äºå°†æ•°æ®æ˜ å°„åˆ°åœ†å‘¨çš„å„ä¸ªå¼§åº¦

###  å±‚æ¬¡æ•°æ®

- D3.jsçš„å±‚çº§æ•°æ®å¯è§†åŒ–ï¼š
	â€¢ å±‚çº§æ•°æ®çš„æ•°æ®ç»“æ„ã€‚
	â€¢ d3.hierarchyï¼šå±‚çº§æ•°æ®çš„å¤„ç†ä¸é¢„è®¡ç®—ã€‚
	â€¢ d3.tree & d3.partitionï¼šå±‚çº§æ•°æ®çš„åˆ’åˆ†ä¸æ˜ å°„ã€‚
- åŸºäºâ€˜d3.treeâ€™å®ç°æ ‘çŠ¶å›¾ï¼š  d3.linkVertical() & d3.linkHorizontal()ã€‚
- åŸºäºâ€˜d3.partitionâ€™å®ç°å†°é”¥å›¾ä¸æ—¥æ™•å›¾



> **d3.hierarchy(data).sum(â€¦).sort(â€¦)**

ä¿æŒæ•°æ®çš„åŸå§‹ç»“æ„ï¼Œè½¬æ¢æˆD3ä¸­çš„hierarcyå¯¹è±¡ï¼Œè¿”å›çš„æ•°æ®å¸¦æœ‰è‹¥å¹²æ¥å£

heightï¼šæ‰€åœ¨èŠ‚ç‚¹çš„é«˜åº¦ï¼Œ depthï¼šæ‰€åœ¨èŠ‚ç‚¹çš„æ·±åº¦
childrenï¼šåŸæœ¬æ•°æ®çš„æ ¼å¼è¢«ä¿ç•™ï¼Œ parentï¼šåˆ°çˆ¶èŠ‚
dataï¼šåˆ°åŸå§‹æ•°æ®çš„æ˜ å°„ï¼Œ valueï¼šèŠ‚ç‚¹çš„å‚è€ƒå€¼ã€‚

- .sum(â€¦)ï¼šèŠ‚ç‚¹çš„å–å€¼ï¼Œçˆ¶èŠ‚ç‚¹çš„å–å€¼ç­‰äºå­èŠ‚ç‚¹çš„å–å€¼ä¹‹å’Œ

- .sort(â€¦)ï¼šå¯¹æ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¸‹è®¾çš„å­èŠ‚ç‚¹ä»¬è¿›è¡Œæ’åº

![](images/hierarchy.png)

- d3.hierarchy(data).descendants()ï¼š æŠŠå±‚çº§ç»“æ„â€˜æ‹å¹³â€™ï¼Œå¹¿åº¦ä¼˜å…ˆè¿”å›å±‚çº§ç»“æ„ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚
  â€¢ ç”¨äºèŠ‚ç‚¹ç›¸å…³çš„Data-Joinï¼Œå¦‚æ·»åŠ ä»£è¡¨èŠ‚ç‚¹çš„å›¾å…ƒï¼ˆçŸ©å½¢ã€åœ†ï¼‰ ç­‰ã€‚

- d3.hierarchy(data).links()ï¼š è¿”å›å±‚çº§ç»“æ„ä¸­çš„æ‰€æœ‰é“¾æ¥ï¼Œä»¥â€˜sourceâ€™å’Œâ€˜targetâ€™çš„å½¢å¼ã€‚
  â€¢ ä¸»è¦ç”¨äºè¿çº¿ç›¸å…³çš„Data-Joinï¼Œå¦‚æ·»åŠ èŠ‚ç‚¹é—´çš„è¿çº¿ã€‚

  

> **d3.treeï¼šæ ‘å½¢å›¾çš„æ˜ å°„å‡½æ•°**

tree(d3.hierarchy(data))ï¼š  æŠŠd3.hierarchy(â€¦)è¿”å›çš„æ•°æ®åœ¨ç”»å¸ƒä¸Šåˆ’åˆ†ï¼Œ å¾—åˆ°æ¯ä¸ªèŠ‚ç‚¹åœ¨ç”»å¸ƒä¸­çš„ä½ç½®ã€‚

- tree.size([width, height])ï¼šæ ‘å½¢åŒºåŸŸçš„æ¯”ä¾‹å°ºæ˜ å°„ï¼Œå³æ ‘å½¢ç»“æ„è¦ç”»åˆ°å¤šå¤§çš„ç”»å¸ƒä¸Šã€‚
  `d3.tree().size([innerWidth, innerHeight])(d3.hierarchy(data));`



> **d3.partitionï¼šå±‚çº§åŒºåŸŸçš„æ˜ å°„å‡½æ•°**

partition(d3.hierarchy(data))ï¼šæŠŠd3.hierarchy(â€¦)è¿”å›çš„æ•°æ®åœ¨ç”»å¸ƒä¸Šåˆ’åˆ†ï¼Œ å¾—åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½®å’Œæ‰€å åŒºåŸŸï¼Œæ‰€å åŒºåŸŸçš„æ¯”ä¾‹éšå±‚çº§çš„å€¼ã€‚  åŒºåŸŸç”±å››ä¸ªå€¼ç¡®å®šï¼Œ ä½†å¹¶ä¸ä¸€å®šçŸ©å½¢ã€‚

- partition.size([width, height])ï¼šåˆ’åˆ†çš„æ¯”ä¾‹å°ºæ˜ å°„

```js
let hiedata = d3.hierarchy(data).sum(d => d.population)
																.sort((a, b) => b.population - a.population)
root = d3.partition().size([2 * Math.PI, 500])(hiedata)   // å†°é”¥å›¾
// root = d3.partition().size([height, width])(hiedata)   // æ°æˆä¸€åœˆ --->  æ—¥æ™•å›¾
```
-   â€˜d3.partitionâ€™å®ç°å†°é”¥å›¾ï¼š æ ¹æ®å„ä¸ªèŠ‚ç‚¹æ‰€å çš„åŒºåŸŸï¼Œç›´æ¥æ¯ä¸ªèŠ‚ç‚¹Data-JoinçŸ©å½¢å›¾å…ƒ  

```js
g.selectAll('.datarect').data(root.descendants()).join('rect')
.attr('class', 'datarect').attr('x', d => d.y0).attr('y', d => d.x0)
.attr('height', d => d.x1 - d.x0).attr('width', d => d.y1 - d.y0).attr("fill", fill);
```

- â€˜d3.partitionâ€™å®ç°æ—¥æ™•å›¾

â€‹    d3.arc(â€¦)ï¼šæ ¹æ®ç»‘å®šçš„æ•°æ®è°ƒèŠ‚èµ·å§‹è§’åº¦ã€ç»ˆæ­¢è§’åº¦ã€ å†…åŠå¾„ä¸å¤–åŠå¾„ã€‚å˜é‡dæ˜¯æ¯ä¸ªå¼§ç»‘å®šçš„æ•°æ®

![](images/æ—¥æ™•å›¾.png)

- å†°é”¥å›¾ä¸æ—¥æ™•å›¾çš„**æ–‡æœ¬**

  ä¸æ˜¾ç¤ºè¿‡é•¿æ–‡æœ¬æˆ–å°åŒºåŸŸçš„æ–‡æœ¬ï¼š`root.descendants().filter(d => d.depth && (d.x1 - d.x0) > Math.PI / 65 && d.data.name.length < 15)`

```js
.attr("transform", function (d) {
    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
    const y = (d.y0 + d.y1) / 2;
    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180}) translate(0, 5)`;
})
```



>   **â€˜d3.treeâ€™å®ç°æ ‘çŠ¶å›¾**  
>

éœ€è¦ç”¨åˆ°çš„å›¾å…ƒï¼šâ€¢ åœ†(Data-Join)ã€  â€¢ æ–‡æœ¬(Data-Join)ã€   â€¢ è¿æ¥çº¿(d3.linkVertical)ã€‚

- d3.linkVerticalã€d3.linkHorizontal ï¼šè¿”å›å‡½æ•°ï¼Œè¾“å…¥ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œ è¾“å‡º`<path>`çš„â€˜dâ€™å±æ€§ï¼Œä¸¤è€…ç¬”é¡ºä¸åŒã€‚

```js
const data1 = {'source': {'x': 100, 'y': 100}, 'target': {'x': 600, 'y': 900}};
const pathH = d3.linkHorizontal().x(d => d.x).y(d => d.y);
const pathV = d3.linkVertical().x(d => d.x).y(d => d.y);
svg.append('path').attr('d', pathH(data1)).attr('stroke', 'steelblue');
svg.append('path').attr('d', pathV(data1)).attr('stroke', 'green');
```

å°†d3.hierarchy(data).links()è¿”å›å±‚çº§ç»“æ„ä¸­çš„æ‰€æœ‰é“¾æ¥ï¼Œä½¿ç”¨d3.linkVerticalè¿æ¥èµ·æ¥

```js
g.selectAll("path").data(root.links())
.join("path").attr("fill", "none").attr("stroke", "black").attr("stroke-width", 1.5)
.attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));
```

- æ¯ä¸ªèŠ‚ç‚¹d3.hierarchy(data).descendants() --> åœ†ç‚¹(Data-Join)

```js
g.selectAll('circle').data(root.descendants()).join('circle')
										 .attr("stroke-width", 3).attr("fill", fill)
										 .attr('cx', d => d.x).attr('cy', d => d.y).attr("r", 6);
```

- æ–‡æœ¬çš„å±æ€§

```js
g.selectAll('text').data(root.descendants()).join('text')
.attr("text-anchor", d => d.children ? "end" : "start") // æ ¹èŠ‚ç‚¹æ–‡æœ¬å‘å¤–ã€éæ ¹èŠ‚ç‚¹æ–‡æœ¬å‘å†…
.attr('x', d => d.x).attr('y', d => d.y + (d.children ? -10 : 10))
.text(d => d.data.name)
.attr('writing-mode', 'vertical-rl')  // æ–‡æœ¬çš„è¡Œæ–‡æ–¹å‘ä¸ºå‚ç›´
.attr('text-orientation', 'upright')
```



###  ç½‘ç»œæ•°æ®

- ç½‘ç»œæ•°æ®çš„æ•°æ®ç»“æ„ï¼Ÿ
- åŸºäº`<path>`å®ç°å¼§é•¿è¿æ¥å›¾ï¼š `<path>`çš„å¼§çº¿å‘½ä»¤ã€‚
- åŸºäºâ€˜d3.chordâ€™ä¸â€˜d3.ribbonâ€™å®ç°å¼¦å›¾ï¼šd3.chordé¢„â€˜åˆ†é…â€™åœ†å‘¨ã€d3.ribbonç”Ÿæˆå¼¦çš„â€˜dâ€™å±æ€§ã€‚
-  D3.jsåŠ›æ¨¡æ‹ŸåŸºç¡€ï¼š
  â€¢ d3-forceçš„æ€»ä½“é…ç½®ã€‚
  â€¢ ä¸åŒåŠ›çš„ä½œç”¨ä¸â€˜Tic-Tocâ€™ã€‚
-  åŸºäºâ€˜d3-forceâ€™å®ç°åŠ›å¯¼å›¾



















![](images/all-api.png)































